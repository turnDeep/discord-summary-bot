# Discord Summary Bot - 全チャンネル監視版（週次サマリー機能付き）

このボットは、招待されたDiscordサーバーの**全てのテキストチャンネル**を自動的に監視し、1日3回の定期要約に加えて、**週次サマリー**を生成してbot専用チャンネルに投稿します。

## 主な特徴

- **全チャンネル自動監視**: 招待されたサーバーの全テキストチャンネルを自動的に監視
- **自動チャンネル作成**: bot専用の要約チャンネル（`bot-summaries`）を自動作成
- **1日3回の定期要約**: 
  - **6時**: 過去24時間分の全体要約
  - **12時**: 朝6時からの6時間分の要約
  - **18時**: 正午からの6時間分の要約
- **週次サマリー機能** 🆕: 
  - **毎週月曜日6時**: 過去1週間分の活動を総括（緑色の枠で投稿）
- **Gemini 2.5 Pro使用**: Google の最新AIモデルで高品質な要約を生成
- **複数サーバー対応**: 複数のサーバーに招待されても、それぞれ独立して動作
- **プライバシー配慮**: bot専用チャンネルへの投稿は要約対象外
- **1週間分のメッセージ保持**: 週次サマリーのため、過去1週間分のメッセージを保持
- **API使用量管理**: 1日最大1,500回のAPI呼び出し制限を管理・表示
- **メモリ効率化**: 定期的なクリーンアップとガベージコレクション

## 動作の仕組み

1. **ボットをサーバーに招待**すると、自動的に `bot-summaries` チャンネルを作成（または既存のものを使用）
2. **全てのテキストチャンネル**でのメッセージを監視・記録（最大1週間分）
3. **1日3回の定時**と**週1回（月曜朝6時）**に、それぞれの期間の活動をまとめて要約を生成
4. **1件以上**のメッセージがあれば、`bot-summaries` チャンネルに要約を投稿

## 必要な要件

- Python 3.11+
- Discord Bot Token
- Google API Key (Gemini API用)
- 必要な権限:
  - メッセージを読む (View Channels)
  - メッセージを送信する (Send Messages)
  - メッセージ履歴を読む (Read Message History)
  - チャンネルを管理する (Manage Channels) - bot用チャンネル作成のため
  - 埋め込みリンク (Embed Links)

## セットアップ

### 1. 依存関係のインストール

```bash
pip install -r requirements.txt
```

### 2. 環境設定

`.env` ファイルを作成し、以下の内容を設定：

```env
# Discord Bot Token (必須)
DISCORD_BOT_TOKEN=your_discord_bot_token

# Google API Key (必須)
GOOGLE_API_KEY=your_google_api_key

# オプション設定
GEMINI_MODEL=gemini-2.5-pro      # 使用するモデル（デフォルト: gemini-2.5-pro）
BOT_CHANNEL_NAME=bot-summaries   # Bot用チャンネル名
MAX_MESSAGES_PER_SUMMARY=500      # 1回の要約の最大メッセージ数
```

### 3. ボットの起動

```bash
python bot.py
```

## コマンド一覧

| コマンド | 説明 | 権限 |
|---------|------|------|
| `!summary` | 過去24時間の要約を手動で生成 | 全員 |
| `!summary [時間]` | 指定時間分の要約を生成（例: `!summary 168` で過去1週間） | 全員 |
| `!status` | ボットの現在の状態と次回の要約時刻を表示 | 全員 |
| `!toggle_summary` | このサーバーの自動要約のON/OFF切り替え | 管理者 |
| `!set_summary_channel #channel` | 要約の投稿先チャンネルを変更 | 管理者 |
| `!api_usage` | Gemini APIの使用状況を表示 | 管理者 |
| `!system` | システムリソースの使用状況を表示 | 管理者 |

## 要約スケジュール

| 時刻 | 要約期間 | 説明 | 色 |
|------|---------|------|-----|
| 毎日 6:00 | 過去24時間 | 前日の活動全体を総括する完全な要約 | 紫 |
| 毎日 12:00 | 朝6時〜正午 | 午前中の活動要約 | 青 |
| 毎日 18:00 | 正午〜18時 | 午後の活動要約 | オレンジ |
| **月曜 6:00** 🆕 | **過去1週間** | **週の活動を総括する週次サマリー** | **緑** |

## 要約の内容

### 通常の要約（日次）
要約には以下の情報が含まれます：

1. **統計情報（簡潔表示）**
   - 総メッセージ数
   - アクティブなチャンネル数
   - 投稿者数

2. **チャンネル別活動状況**
   - 最もアクティブなチャンネルTOP3

3. **AI生成の要約**
   - 各チャンネルの主要なトピック
   - 重要な決定事項や合意事項
   - 注目すべき情報
   - 全体的な活動状況
   - 最大1,500文字の簡潔な要約

### 週次サマリー（月曜日）🆕
週次サマリーには以下の特徴があります：

1. **拡張された統計**
   - 1週間分の総メッセージ数
   - 最もアクティブなチャンネルTOP5

2. **総括的な分析**
   - 週全体のトピックと傾向
   - 主要な決定事項と進捗
   - 週の前半と後半での変化
   - チャンネルごとの活動傾向

3. **詳細な要約**
   - 最大1,800文字の総括的な要約
   - 緑色の枠で視覚的に区別

## 技術的な詳細

### 使用ライブラリ
- **discord.py** >= 2.3.0 - Discord API連携
- **google-genai** >= 1.24.0 - Google Gen AI SDK（新バージョン）
- **python-dotenv** >= 1.0.0 - 環境変数管理
- **psutil** >= 5.9.0 - システムリソース監視

### メモリ管理
- **1週間（168時間）以上前のメッセージを自動削除** 🆕
- 6時間ごとにガベージコレクション実行
- サーバーごとにメッセージをdequeで効率的に管理
- 大規模サーバーでは週次サマリーのためメモリ使用量が増加する可能性

### API利用制限
- Gemini API: 1日最大1,500回の呼び出し
- 毎日0時にカウンターがリセット
- 週次サマリーは週1回のため、API使用量への影響は限定的
- `!api_usage`コマンドで使用状況を確認可能

## プライバシーとセキュリティ

- ボットは招待されたサーバー内のメッセージのみアクセス可能
- bot専用チャンネル（`bot-summaries`）への投稿は監視対象外
- メッセージは最大1週間メモリに保存され、その後自動削除
- 他のサーバーの情報にはアクセスできません
- ユーザーの表示名（ニックネーム）を使用してプライバシーに配慮

## 複数サーバーでの使用

- 複数のサーバーにボットを招待可能
- 各サーバーで独立して動作
- サーバーごとに異なる要約チャンネルを設定可能
- サーバーごとに要約機能のON/OFF切り替え可能
- API使用量は全サーバー合計で1日最大1,500回

## トラブルシューティング

### bot-summariesチャンネルが作成されない
- ボットに「チャンネルを管理する」権限があることを確認
- 手動でチャンネルを作成し、`!set_summary_channel` で設定も可能

### 要約が投稿されない
- `!status` コマンドで監視状況と次回の要約時刻を確認
- `!toggle_summary` で要約機能が有効になっているか確認
- 対象時間内に1件以上のメッセージがあったか確認

### 週次サマリーが投稿されない🆕
- 月曜日の朝6時（JST）に投稿されることを確認
- 過去1週間に1件以上のメッセージがあることが必要
- `!status`で次回の週次サマリー時刻を確認

### 特定のチャンネルを監視対象外にしたい
- 現在のバージョンでは、ボットがアクセスできる全チャンネルが監視対象
- チャンネルの権限設定でボットのアクセスを制限することで対応可能

### 時刻がずれている
- サーバーのタイムゾーン設定を確認（日本時間JST基準）
- VPSやクラウドサービスを使用している場合は、システム時刻の設定を確認

### Gemini APIエラーが発生する
- API Keyが正しく設定されているか確認
- `!api_usage`で使用量が制限に達していないか確認
- エラー時は自動的に簡易要約（頻出単語抽出）にフォールバック

### メモリ使用量が多い🆕
- `!system`コマンドでメモリ使用状況を確認
- 1週間分のメッセージ保持により、メモリ使用量が以前より増加
- 大規模サーバーでは特に注意が必要
- 定期的な自動クリーンアップが実行されているか確認

## 注意事項

- 大規模なサーバー（多数のアクティブチャンネル）では、要約が長くなる可能性があります
- Gemini APIの日次制限（1,500回）に注意してください（週次サマリーの追加により、1日約3.14回×サーバー数の使用）
- **1週間分のメッセージを保持するため、メモリ使用量が増加します** 🆕
- 深夜〜早朝（18時〜翌6時）の活動は翌朝6時の24時間要約に含まれます
- 手動要約は最大168時間（1週間）分まで対応可能
- 週次サマリーは月曜日の朝6時に固定（変更不可）

## ライセンス

このプロジェクトは教育・個人利用を目的として提供されています。